<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è§†é¢‘æ‰‘å…‹ (Joker Poker)</title>
    <style>
        body {
            background-color: #2c0e0e; /* æ·±çº¢è¤è‰²èƒŒæ™¯ï¼Œæ¨¡ä»¿ä½ çš„æˆªå›¾ */
            color: white;
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            user-select: none;
        }

        /* èµ”ç‡è¡¨æ ·å¼ */
        .paytable {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            background: #4a1a1a;
            padding: 15px;
            border: 2px solid #a37c48;
            border-radius: 8px;
            margin-top: 20px;
            width: 80%;
            max-width: 600px;
            font-size: 14px;
        }
        .paytable div {
            display: flex;
            justify-content: space-between;
        }
        .highlight {
            color: #ffd700;
            font-weight: bold;
            text-shadow: 0 0 5px orange;
        }

        /* ç‰Œæ¡ŒåŒºåŸŸ */
        .game-area {
            display: flex;
            gap: 10px;
            margin: 40px 0;
        }

        .card {
            width: 100px;
            height: 140px;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: black;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            border: 4px solid transparent;
            transition: transform 0.1s;
        }
        
        .card.red { color: #d00; }
        .card.black { color: #000; }
        .card.joker { color: purple; }

        /* é€‰ä¸­ä¿ç•™æ ·å¼ */
        .card.held {
            border-color: #ffd700;
            transform: translateY(-15px);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        .card.held::after {
            content: "ä¿ç•™";
            position: absolute;
            bottom: -25px;
            color: #ffd700;
            font-size: 14px;
            background: #000;
            padding: 2px 5px;
        }

        /* æŒ‰é’®å’Œä¿¡æ¯åŒºåŸŸ */
        .controls {
            text-align: center;
        }
        button {
            padding: 15px 40px;
            font-size: 20px;
            background: #d4a017;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
            box-shadow: 0 4px 0 #8c6a0f;
        }
        button:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status {
            margin-bottom: 10px;
            font-size: 20px;
            color: #ffd700;
            min-height: 30px;
        }
        .balance {
            margin-top: 10px;
            font-size: 18px;
        }
    </style>
</head>
<body>

    <div class="paytable" id="paytable">
        <div id="row-royal"><span>çš‡å®¶åŒèŠ±é¡º</span><span>x100</span></div>
        <div id="row-flush"><span>åŒèŠ±</span><span>x4</span></div>
        
        <div id="row-five"><span>äº”æ¡ (å¸¦é¬¼ç‰Œ)</span><span>x50</span></div>
        <div id="row-straight"><span>é¡ºå­</span><span>x3</span></div>
        
        <div id="row-strflush"><span>åŒèŠ±é¡º</span><span>x20</span></div>
        <div id="row-three"><span>ä¸‰æ¡</span><span>x1</span></div>
        
        <div id="row-four"><span>å››æ¡</span><span>x10</span></div>
        <div id="row-twopair"><span>ä¸¤å¯¹</span><span>x1</span></div>
        
        <div id="row-full"><span>è‘«èŠ¦</span><span>x5</span></div>
        <div id="row-pair"><span>ä¸€å¯¹Â·æ•£ç‰Œ</span><span>x0</span></div>
    </div>

    <div class="game-area" id="card-container">
        </div>

    <div class="controls">
        <div class="status" id="status-text">å‡†å¤‡å¼€å§‹</div>
        <button id="action-btn" onclick="handleAction()">å‘ç‰Œ (Deal)</button>
        <div class="balance">ä½™é¢: <span id="money">100</span></div>
    </div>

<script>
    // === æ¸¸æˆé…ç½® ===
    const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
    const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    // åŒ…å«é¬¼ç‰Œ
    let deck = [];
    let hand = [];
    let gameState = 'DEAL'; // DEAL (è¿˜æ²¡å‘ç‰Œ) -> DRAW (é€‰ç‰Œé˜¶æ®µ)
    let money = 100;
    const BET = 1; // æ¯æ¬¡ä¸‹æ³¨é¢

    // === åˆå§‹åŒ– ===
    const cardContainer = document.getElementById('card-container');
    const actionBtn = document.getElementById('action-btn');
    const statusText = document.getElementById('status-text');
    const moneyDisplay = document.getElementById('money');

    // ç”Ÿæˆ5ä¸ªç©ºçš„å¡ç‰Œæ§½
    for(let i=0; i<5; i++) {
        let div = document.createElement('div');
        div.className = 'card';
        div.onclick = () => toggleHold(i);
        div.innerHTML = '?';
        cardContainer.appendChild(div);
    }

    // === æ ¸å¿ƒé€»è¾‘ ===

    function createDeck() {
        let d = [];
        for (let s of SUITS) {
            for (let r of RANKS) {
                d.push({ suit: s, rank: r, val: RANKS.indexOf(r) + 2, isJoker: false });
            }
        }
        // åŠ å…¥ä¸€å¼ é¬¼ç‰Œ
        d.push({ suit: 'JOKER', rank: 'JOKER', val: 99, isJoker: true });
        return d;
    }

    function shuffle(d) {
        for (let i = d.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [d[i], d[j]] = [d[j], d[i]];
        }
        return d;
    }

    function handleAction() {
        if (gameState === 'DEAL') {
            // ä¸‹æ³¨
            if (money < BET) {
                alert("ä½™é¢ä¸è¶³ï¼");
                return;
            }
            money -= BET;
            updateUI();
            
            // æ´—ç‰Œå‘ç‰Œ
            deck = shuffle(createDeck());
            hand = [];
            for(let i=0; i<5; i++) {
                hand.push({ ...deck.pop(), held: false });
            }
            
            gameState = 'DRAW';
            actionBtn.innerText = "æ¢ç‰Œ (Draw)";
            statusText.innerText = "è¯·é€‰æ‹©è¦ä¿ç•™çš„ç‰Œ...";
            clearHighlights();
            renderHand();
        } 
        else if (gameState === 'DRAW') {
            // æ¢ç‰Œé€»è¾‘
            for(let i=0; i<5; i++) {
                if (!hand[i].held) {
                    hand[i] = { ...deck.pop(), held: false };
                }
            }
            
            renderHand();
            evaluateHand(); // ç»“ç®—
            
            gameState = 'DEAL';
            actionBtn.innerText = "å†æ¬¡å‘ç‰Œ (Deal)";
        }
    }

    function toggleHold(index) {
        if (gameState !== 'DRAW') return;
        hand[index].held = !hand[index].held;
        renderHand();
    }

    function renderHand() {
        const divs = cardContainer.children;
        for(let i=0; i<5; i++) {
            const card = hand[i];
            const div = divs[i];
            
            div.className = `card ${card.held ? 'held' : ''}`;
            
            if (card.isJoker) {
                div.innerHTML = "ğŸ¤¡<br><small>JOKER</small>";
                div.classList.add('joker');
            } else {
                div.innerHTML = `${card.rank}<br>${card.suit}`;
                if (card.suit === 'â™¥' || card.suit === 'â™¦') {
                    div.classList.add('red');
                    div.classList.remove('black');
                } else {
                    div.classList.add('black');
                    div.classList.remove('red');
                }
            }
        }
        updateUI();
    }

    function updateUI() {
        moneyDisplay.innerText = money;
    }

    function clearHighlights() {
        document.querySelectorAll('.paytable div').forEach(el => el.classList.remove('highlight'));
    }

    // === ç‰Œå‹åˆ¤æ–­ç®—æ³• (ç®€åŒ–ç‰ˆ) ===
    function evaluateHand() {
        let jokers = hand.filter(c => c.isJoker).length;
        let normalCards = hand.filter(c => !c.isJoker);
        
        // ç»Ÿè®¡ç‚¹æ•°å’ŒèŠ±è‰²
        let counts = {};
        let suits = {};
        normalCards.forEach(c => {
            counts[c.val] = (counts[c.val] || 0) + 1;
            suits[c.suit] = (suits[c.suit] || 0) + 1;
        });

        let maxCount = 0; // æœ€å¤šçš„åŒç‚¹æ•°å¼ æ•°
        for(let k in counts) maxCount = Math.max(maxCount, counts[k]);
        
        let maxSuit = 0; // æœ€å¤šçš„åŒèŠ±è‰²å¼ æ•°
        for(let k in suits) maxSuit = Math.max(maxSuit, suits[k]);

        // åˆ¤æ–­é¡ºå­ (æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œç”¨ç®€åŒ–é€»è¾‘ï¼šæ’åºåæ£€æŸ¥é—´éš”)
        let isStraight = checkStraight(normalCards, jokers);
        
        let isFlush = (maxSuit + jokers) >= 5;
        let isRoyal = false;

        // çš‡å®¶åŒèŠ±é¡ºç‰¹åˆ¤ (10, J, Q, K, A)
        if (isFlush && isStraight) {
            let royalCards = normalCards.filter(c => c.val >= 10);
            if (royalCards.length + jokers >= 5) isRoyal = true;
        }

        // === ç»“ç®—åˆ¤å®šé¡ºåº (ä»å¤§åˆ°å°) ===
        let win = 0;
        let msg = "æœªä¸­å¥–";
        let highlightId = "";

        if (isRoyal) {
            win = 100; msg = "çš‡å®¶åŒèŠ±é¡º!"; highlightId = "row-royal";
        } else if ((maxCount + jokers) >= 5) {
            win = 50; msg = "äº”æ¡!"; highlightId = "row-five";
        } else if (isFlush && isStraight) {
            win = 20; msg = "åŒèŠ±é¡º!"; highlightId = "row-strflush";
        } else if ((maxCount + jokers) === 4) {
            win = 10; msg = "å››æ¡!"; highlightId = "row-four";
        } else if (checkFullHouse(counts, jokers)) {
            win = 5; msg = "è‘«èŠ¦!"; highlightId = "row-full";
        } else if (isFlush) {
            win = 4; msg = "åŒèŠ±!"; highlightId = "row-flush";
        } else if (isStraight) {
            win = 3; msg = "é¡ºå­!"; highlightId = "row-straight";
        } else if ((maxCount + jokers) === 3) {
            win = 1; msg = "ä¸‰æ¡!"; highlightId = "row-three";
        } else if (checkTwoPair(counts, jokers)) {
            win = 1; msg = "ä¸¤å¯¹!"; highlightId = "row-twopair";
        }

        if (win > 0) {
            money += win * BET;
            statusText.innerText = `${msg} èµ¢å¾— ${win} å€!`;
            if(highlightId) document.getElementById(highlightId).classList.add('highlight');
        } else {
            statusText.innerText = "å¾ˆé—æ†¾ï¼Œæœªä¸­å¥–ã€‚";
        }
        updateUI();
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥é¡ºå­ (å…è®¸è·³è¿‡çš„ä½ç½®ç”±é¬¼ç‰Œå¡«è¡¥)
    function checkStraight(cards, jokerCount) {
        if (cards.length === 0) return true; // å…¨æ˜¯é¬¼ç‰Œ
        let vals = cards.map(c => c.val).sort((a,b) => a-b);
        // å»é‡
        vals = [...new Set(vals)]; 
        
        // å¦‚æœå»é‡åå¼ æ•° + é¬¼ç‰Œ < 5ï¼Œè‚¯å®šç»„ä¸æˆé¡ºå­
        if (vals.length + jokerCount < 5) return false;

        // æ£€æŸ¥é—´éš”
        // å°è¯•æ¯ä¸ªå¯èƒ½çš„èµ·å§‹ç‚¹
        // è¿™é‡Œåªæ˜¯ç®€å•æ£€æŸ¥ï¼šæœ€å¤§å€¼ - æœ€å°å€¼ æ˜¯å¦ <= 4 (ä¸”æ²¡æœ‰é‡å¤ï¼Œä¸Šé¢å·²å»é‡)
        // æ³¨æ„ï¼šAå¯ä»¥å½“1ä¹Ÿå¯ä»¥å½“14ã€‚è¿™é‡Œç®€åŒ–åªå½“14ã€‚
        // å¦‚æœè¦å®Œç¾æ”¯æŒA-5é¡ºå­ï¼Œéœ€è¦é¢å¤–å¤„ç†ã€‚
        
        let gap = vals[vals.length-1] - vals[0];
        if (gap <= 4) return true;
        
        return false; 
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥è‘«èŠ¦ (3+2)
    function checkFullHouse(counts, jokers) {
        // æœ‰ä¸¤ç»„ç‰Œï¼Œä¸€ç»„å¼ æ•°+å¦ä¸€ç»„å¼ æ•°+é¬¼ç‰Œ >= 5
        let values = Object.values(counts);
        if (values.length === 2) return true; // ä¸¤å †ç‰Œï¼Œé¬¼ç‰Œè‚¯å®šèƒ½è¡¥
        if (values.length === 1 && jokers >= 1) return true; // ä¸€å †ç‰Œ+é¬¼ç‰Œ
        return false;
    }

    function checkTwoPair(counts, jokers) {
        let pairs = 0;
        for(let k in counts) {
            if (counts[k] >= 2) pairs++;
        }
        // ç°æœ‰ä¸¤å¯¹ï¼Œæˆ–è€…æœ‰ä¸€å¯¹+é¬¼ç‰Œï¼Œæˆ–è€…é¬¼ç‰Œ>=2
        if (pairs >= 2) return true;
        if (pairs === 1 && jokers >= 1) return true;
        if (jokers >= 2) return true; // ç†è®ºä¸Šè¿™ä¼šè¢«ä¸‰æ¡æˆªèƒ¡ï¼Œä½†æ”¾åœ¨åˆ¤å®šé“¾åé¢ä½œä¸ºä¿åº•
        return false;
    }
</script>

</body>
</html>