<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>çš‡å®¶è§†é¢‘æ‰‘å…‹</title>
    <style>
        /* === èµŒåœºç»¿ç»’å¸ƒèƒŒæ™¯ === */
        body {
            background: radial-gradient(circle at center, #358c35 0%, #003300 100%);
            color: white;
            font-family: 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
            overflow-x: hidden;
        }

        /* === èµ”ç‡è¡¨ === */
        .paytable {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border: 3px solid #ffd700;
            border-radius: 12px;
            margin-top: 30px;
            width: 85%;
            max-width: 650px;
            font-size: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        .paytable div {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            padding-bottom: 2px;
        }
        .highlight {
            color: #fff;
            background-color: #b8860b;
            padding: 0 5px;
            border-radius: 4px;
            box-shadow: 0 0 15px #ffd700;
            animation: pulse 0.8s infinite alternate;
        }
        @keyframes pulse {
            from { box-shadow: 0 0 10px #ffd700; }
            to { box-shadow: 0 0 25px #ffaa00; }
        }

        /* === ç‰Œæ¡ŒåŒºåŸŸ === */
        .game-area {
            display: flex;
            gap: 15px;
            margin: 40px 0;
            perspective: 1000px;
            min-height: 160px;
        }

        .card {
            width: 110px;
            height: 154px;
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #333;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
            transition: all 0.2s;
            border: 2px solid #ccc;
        }
        
        /* ç‰Œé¢é¢œè‰² */
        .card.red { color: #d00; }
        .card.black { color: #222; }
        .card.joker { color: #800080; }

        /* èƒŒé¢æ ·å¼ */
        .card.back {
            background: repeating-linear-gradient(45deg, #cc0000, #cc0000 10px, #aa0000 10px, #aa0000 20px);
            border: 2px solid white;
            color: transparent;
        }
        .card.back::after { content: ''; } /* éšè—æ–‡å­— */

        /* å¼ƒç‰Œæ ·å¼ */
        .card.discard {
            transform: translateY(20px) scale(0.95);
            filter: brightness(0.6) sepia(0.2);
            border-color: #cc0000;
        }
        .card.discard::after {
            content: "æ¢æ‰";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            color: #fff;
            font-size: 18px;
            background: rgba(200, 0, 0, 0.9);
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* === æ§åˆ¶åŒº === */
        .controls {
            text-align: center;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
        }

        .status {
            margin-bottom: 15px;
            font-size: 24px;
            color: #ffd700;
            text-shadow: 2px 2px 2px #000;
            font-weight: bold;
            min-height: 35px;
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        button {
            padding: 12px 30px;
            font-size: 20px;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            background: linear-gradient(to bottom, #ff4d4d 0%, #cc0000 100%);
            box-shadow: 0 5px 0 #8b0000, 0 8px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            margin: 5px;
            transition: all 0.1s;
        }
        button:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #8b0000;
        }
        button:disabled {
            background: #555;
            box-shadow: none;
            color: #aaa;
            cursor: not-allowed;
            transform: translateY(4px);
        }

        /* è“è‰²æŒ‰é’® (ç”¨äºæ”¶é’±/å°åŠŸèƒ½) */
        button.btn-blue {
            background: linear-gradient(to bottom, #4d94ff 0%, #0052cc 100%);
            box-shadow: 0 5px 0 #003380, 0 8px 10px rgba(0,0,0,0.3);
        }
        button.btn-blue:active { box-shadow: 0 1px 0 #003380; }

        /* ç»¿è‰²æŒ‰é’® (ç”¨äºèµŒåš) */
        button.btn-green {
            background: linear-gradient(to bottom, #4dff88 0%, #009933 100%);
            box-shadow: 0 5px 0 #006622, 0 8px 10px rgba(0,0,0,0.3);
        }
        button.btn-green:active { box-shadow: 0 1px 0 #006622; }

        /* ä¸‹æ³¨æ§åˆ¶æ¡ */
        .bet-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 10px;
        }
        .bet-display {
            font-size: 22px;
            color: #ffd700;
            font-family: monospace;
            width: 30px;
        }
        .btn-small {
            padding: 5px 15px;
            font-size: 18px;
            border-radius: 5px;
        }

        .balance-box {
            margin-top: 15px;
            display: inline-block;
            background: #000;
            border: 2px solid #555;
            padding: 10px 30px;
            border-radius: 5px;
            font-family: monospace;
            color: #0f0;
            font-size: 20px;
        }

        /* åšå¼ˆè¦†ç›–å±‚ */
        .gamble-overlay {
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <div class="paytable" id="paytable">
        <div id="row-royal"><span>çš‡å®¶åŒèŠ±é¡º</span><span>x100</span></div>
        <div id="row-five"><span>äº”æ¡ (å¸¦é¬¼ç‰Œ)</span><span>x50</span></div>
        <div id="row-strflush"><span>åŒèŠ±é¡º</span><span>x20</span></div>
        <div id="row-four"><span>å››æ¡</span><span>x10</span></div>
        <div id="row-full"><span>è‘«èŠ¦</span><span>x5</span></div>
        <div id="row-flush"><span>åŒèŠ±</span><span>x4</span></div>
        <div id="row-straight"><span>é¡ºå­</span><span>x3</span></div>
        <div id="row-three"><span>ä¸‰æ¡</span><span>x1</span></div>
        <div id="row-twopair"><span>ä¸¤å¯¹</span><span>x1</span></div>
        <div id="row-pair"><span>é«˜ç‰Œä¸€å¯¹ (J/Q/K/A)</span><span>x1</span></div>
    </div>

    <div class="game-area" id="card-container">
        </div>

    <div class="controls">
        <div class="status" id="status-text">è¯·æŒ‰å‘ç‰Œå¼€å§‹æ¸¸æˆ</div>

        <div id="main-controls">
            <div class="bet-control" id="bet-panel">
                <span style="color:white; font-weight:bold;">ä¸‹æ³¨:</span>
                <button class="btn-small" onclick="changeBet(-1)">-</button>
                <span class="bet-display" id="bet-display">1</span>
                <button class="btn-small" onclick="changeBet(1)">+</button>
            </div>

            <button id="action-btn" onclick="handleAction()">å‘ ç‰Œ (DEAL)</button>
        </div>

        <div id="gamble-controls" style="display: none;">
            <p style="color: #ccc; font-size: 14px; margin: 0 0 10px 0;">çŒœä¸‹ä¸€å¼ ç‰Œçš„å¤§å° (3-8ä¸ºå°ï¼Œ9-é¬¼ç‰Œä¸ºå¤§)</p>
            <button class="btn-green" onclick="playGamble('BIG')">æŠ¼ å¤§ (9-é¬¼)</button>
            <button class="btn-green" onclick="playGamble('SMALL')">æŠ¼ å° (2-8)</button>
            <div style="height: 10px;"></div>
            <button class="btn-blue" onclick="collectWinnings()">æ”¶ä¸‹é‡‘å¸ (æ”¾å¼ƒ)</button>
        </div>

        <div id="win-decision-controls" style="display: none;">
            <button class="btn-green" onclick="startGamble()">æŒ‘æˆ˜åŒå€ (x2)</button>
            <button class="btn-blue" onclick="collectWinnings()">æ”¶ä¸‹é‡‘å¸</button>
        </div>

        <br>
        <div class="balance-box">ä½™é¢: <span id="money">100</span></div>
    </div>

<script>
    // === éŸ³é¢‘è®¾ç½® ===
    const winSound = new Audio('win.mp3');
    const loseSound = new Audio('lose.mp3');
    winSound.load(); loseSound.load();

    // === å¸¸é‡ä¸å˜é‡ ===
    const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
    const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    
    let deck = [];
    let hand = [];
    let gameState = 'DEAL'; // çŠ¶æ€: DEAL, DRAW, WIN_DECISION, GAMBLE
    let money = 100;
    let currentBet = 1;
    let pendingWin = 0; // æš‚å­˜çš„å¥–é‡‘ï¼ˆè¿˜æ²¡æ”¶ä¸‹çš„ï¼‰

    // DOM å…ƒç´ 
    const cardContainer = document.getElementById('card-container');
    const actionBtn = document.getElementById('action-btn');
    const statusText = document.getElementById('status-text');
    const moneyDisplay = document.getElementById('money');
    const betDisplay = document.getElementById('bet-display');
    const betPanel = document.getElementById('bet-panel');
    const mainControls = document.getElementById('main-controls');
    const gambleControls = document.getElementById('gamble-controls');
    const winDecisionControls = document.getElementById('win-decision-controls');

    // === åˆå§‹åŒ– ===
    // æ¸²æŸ“5å¼ èƒŒé¢ç‰Œ
    for(let i=0; i<5; i++) {
        let div = document.createElement('div');
        div.className = 'card back';
        div.onclick = () => toggleDiscard(i);
        cardContainer.appendChild(div);
    }
    updateUI();

    // === æ ¸å¿ƒåŠŸèƒ½ï¼šè°ƒæ•´ä¸‹æ³¨ ===
    function changeBet(amount) {
        if (gameState !== 'DEAL') return; // åªèƒ½åœ¨å‘ç‰Œå‰æ”¹
        let newBet = currentBet + amount;
        if (newBet < 1) newBet = 1;
        if (newBet > 10) newBet = 10;
        currentBet = newBet;
        betDisplay.innerText = currentBet;
    }

    // === æ ¸å¿ƒé€»è¾‘ï¼šä¸»æŒ‰é’® ===
    function handleAction() {
        if (gameState === 'DEAL') {
            // å¼€å§‹æ–°ä¸€å±€
            if (money < currentBet) {
                if(confirm("ä½™é¢ä¸è¶³ï¼æ˜¯å¦é‡ç½®ä¸º 100 ç­¹ç ï¼Ÿ")) money = 100;
                else return;
            }
            money -= currentBet;
            updateUI();
            
            deck = shuffle(createDeck());
            hand = [];
            for(let i=0; i<5; i++) hand.push({ ...deck.pop(), isDiscard: false });
            
            gameState = 'DRAW';
            actionBtn.innerText = "ç¡®è®¤æ¢ç‰Œ";
            statusText.innerText = "è¯·ç‚¹å‡»ä¸æƒ³è¦çš„ç‰Œ (æ¢æ‰)";
            clearHighlights();
            renderHand();
            // é”å®šä¸‹æ³¨
            betPanel.style.opacity = '0.5';
            betPanel.style.pointerEvents = 'none';

        } else if (gameState === 'DRAW') {
            // æ¢ç‰Œé˜¶æ®µ
            // 1. æ­£å¸¸æ¢ç‰Œ
            for(let i=0; i<5; i++) {
                if (hand[i].isDiscard) hand[i] = { ...deck.pop(), isDiscard: false };
            }

            // 2. å¹¸è¿æœºåˆ¶ (5% æ¦‚ç‡å¼ºåˆ¶é¡ºå­ï¼Œä»…ä¾›å¨±ä¹)
            let hasJoker = hand.some(c => c.isJoker);
            if (!hasJoker && Math.random() < 0.05) { 
                hand = generateForcedStraight();
            }
            
            renderHand();
            
            // 3. ç»“ç®—
            let winMultiplier = evaluateHand(); // è¿”å›å€ç‡
            
            if (winMultiplier > 0) {
                // èµ¢äº†ï¼è¿›å…¥å†³ç­–é˜¶æ®µ
                pendingWin = winMultiplier * currentBet;
                gameState = 'WIN_DECISION';
                statusText.innerText = `èµ¢äº† ${pendingWin} é‡‘å¸ï¼è¦æŒ‘æˆ˜åŒå€å—ï¼Ÿ`;
                
                // æ’­æ”¾èƒœåˆ©éŸ³æ•ˆ
                winSound.currentTime = 0; winSound.play().catch(()=>{});

                // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
                mainControls.style.display = 'none';
                winDecisionControls.style.display = 'block';
            } else {
                // è¾“äº†
                statusText.innerText = "æœªä¸­å¥–ï¼Œè¯·å†æ¥å†å‰";
                loseSound.currentTime = 0; loseSound.play().catch(()=>{});
                resetGame();
            }
        }
    }

    // === æ¸¸æˆé‡ç½® (å›åˆ°å‘ç‰Œå‰) ===
    function resetGame() {
        gameState = 'DEAL';
        actionBtn.innerText = "å‘ ç‰Œ (DEAL)";
        mainControls.style.display = 'block';
        winDecisionControls.style.display = 'none';
        gambleControls.style.display = 'none';
        
        // è§£é”ä¸‹æ³¨
        betPanel.style.opacity = '1';
        betPanel.style.pointerEvents = 'auto';
        updateUI();
    }

    // === åŒå€åšå¼ˆé€»è¾‘ ===
    
    // 1. ç©å®¶é€‰æ‹©æŒ‘æˆ˜
    function startGamble() {
        gameState = 'GAMBLE';
        winDecisionControls.style.display = 'none';
        gambleControls.style.display = 'block';
        statusText.innerText = `å½“å‰å¥–é‡‘: ${pendingWin}ã€‚çŒœä¸‹ä¸€å¼ ç‰Œæ˜¯ å¤§ è¿˜æ˜¯ å°ï¼Ÿ`;

        // æ¸…ç©ºæ¡Œé¢ï¼Œåªæ˜¾ç¤ºä¸€å¼ èƒŒé¢ç‰Œ
        cardContainer.innerHTML = '';
        let div = document.createElement('div');
        div.className = 'card back';
        div.id = 'gamble-card';
        cardContainer.appendChild(div);
    }

    // 2. ç©å®¶é€‰æ‹©æ”¶é’±
    function collectWinnings() {
        money += pendingWin;
        pendingWin = 0;
        statusText.innerText = "é‡‘å¸å·²æ”¶å…¥å›Šä¸­ï¼";
        // æ¢å¤5å¼ ç‰Œçš„ç©ºä½
        cardContainer.innerHTML = '';
        for(let i=0; i<5; i++) {
            let div = document.createElement('div');
            div.className = 'card back';
            div.onclick = () => toggleDiscard(i); // é‡æ–°ç»‘å®šäº‹ä»¶
            cardContainer.appendChild(div);
        }
        resetGame();
    }

    // 3. æ‰§è¡ŒçŒœå¤§å°
    function playGamble(choice) {
        // é‡æ–°æ´—ä¸€å‰¯ç‰Œï¼ˆä¿è¯æ¦‚ç‡å…¬å¹³ï¼‰
        let gambleDeck = shuffle(createDeck());
        let card = gambleDeck.pop();
        
        // æ˜¾ç¤ºè¿™å¼ ç‰Œ
        let div = document.getElementById('gamble-card');
        renderSingleCard(div, card);

        // åˆ¤æ–­å¤§å° (2-8 å°, 9-A-Joker å¤§)
        // æˆ‘ä»¬çš„ val: 2=2...8=8, 9=9...A=14, Joker=99
        let isBig = card.val >= 9;
        let isSmall = card.val <= 8;

        let won = false;
        if (choice === 'BIG' && isBig) won = true;
        if (choice === 'SMALL' && isSmall) won = true;

        if (won) {
            pendingWin *= 2;
            statusText.innerText = `çŒœå¯¹äº†ï¼å¥–é‡‘ç¿»å€ä¸º ${pendingWin}ï¼ç»§ç»­å—ï¼Ÿ`;
            winSound.currentTime = 0; winSound.play().catch(()=>{});
            // æŒ‰é’®ä¿æŒä¸å˜ï¼Œå¯ä»¥ç»§ç»­çŒœ
        } else {
            pendingWin = 0;
            statusText.innerText = `çŒœé”™äº†... å¥–é‡‘å½’é›¶ã€‚`;
            loseSound.currentTime = 0; loseSound.play().catch(()=>{});
            
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´åå¼ºåˆ¶ç»“æŸ
            setTimeout(() => {
                // æ¢å¤5å¼ ç©ºç‰Œ
                cardContainer.innerHTML = '';
                for(let i=0; i<5; i++) {
                    let d = document.createElement('div');
                    d.className = 'card back';
                    d.onclick = () => toggleDiscard(i);
                    cardContainer.appendChild(d);
                }
                resetGame();
            }, 2000);
            
            gambleControls.style.display = 'none'; // é˜²æ­¢è¿ç‚¹
        }
    }

    // === è¾…åŠ©æ¸²æŸ“å‡½æ•° ===
    function renderSingleCard(div, card) {
        div.className = 'card'; // ç§»é™¤ back ç±»
        if (card.isJoker) {
            div.innerHTML = "ğŸ¤¡<br><small>é¬¼ç‰Œ</small>";
            div.classList.add('joker');
        } else {
            div.innerHTML = `${card.rank}<br>${card.suit}`;
            if (card.suit === 'â™¥' || card.suit === 'â™¦') div.classList.add('red');
            else div.classList.add('black');
        }
    }

    // === åŸºç¡€æ‰‘å…‹é€»è¾‘ ===
    function createDeck() {
        let d = [];
        for (let s of SUITS) {
            for (let r of RANKS) {
                d.push({ suit: s, rank: r, val: RANKS.indexOf(r) + 2, isJoker: false, isDiscard: false });
            }
        }
        d.push({ suit: 'JOKER', rank: 'JOKER', val: 99, isJoker: true, isDiscard: false });
        return d;
    }

    function shuffle(d) {
        for (let i = d.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [d[i], d[j]] = [d[j], d[i]];
        }
        return d;
    }

    function toggleDiscard(index) {
        if (gameState !== 'DRAW') return;
        hand[index].isDiscard = !hand[index].isDiscard;
        renderHand();
    }

    function renderHand() {
        cardContainer.innerHTML = ''; // æ¸…ç©º
        for(let i=0; i<5; i++) {
            let div = document.createElement('div');
            let card = hand[i];
            
            div.onclick = () => toggleDiscard(i);
            renderSingleCard(div, card); // å¤ç”¨æ¸²æŸ“é€»è¾‘

            if (card.isDiscard) div.classList.add('discard');
            cardContainer.appendChild(div);
        }
        updateUI();
    }

    function generateForcedStraight() {
        let startVal = Math.floor(Math.random() * 9) + 2; 
        let newHand = [];
        for (let i = 0; i < 5; i++) {
            let val = startVal + i;
            let rankStr = '';
            if (val <= 10) rankStr = val.toString();
            else if (val === 11) rankStr = 'J';
            else if (val === 12) rankStr = 'Q';
            else if (val === 13) rankStr = 'K';
            else if (val === 14) rankStr = 'A';
            let suit = SUITS[i % 4]; 
            newHand.push({ suit: suit, rank: rankStr, val: val, isJoker: false, isDiscard: false });
        }
        if (Math.random() < 0.2) {
            let replaceIdx = Math.floor(Math.random() * 5);
            newHand[replaceIdx] = { suit: 'JOKER', rank: 'JOKER', val: 99, isJoker: true, isDiscard: false };
        }
        return newHand;
    }

    function updateUI() {
        moneyDisplay.innerText = money;
    }

    function clearHighlights() {
        document.querySelectorAll('.paytable div').forEach(el => el.classList.remove('highlight'));
    }

    // === ç»“ç®—ç®—æ³• (è¿”å›å€ç‡) ===
    function evaluateHand() {
        let jokers = hand.filter(c => c.isJoker).length;
        let normalCards = hand.filter(c => !c.isJoker);
        let counts = {};
        let suits = {};
        
        normalCards.forEach(c => {
            counts[c.val] = (counts[c.val] || 0) + 1;
            suits[c.suit] = (suits[c.suit] || 0) + 1;
        });

        let maxCount = 0; 
        for(let k in counts) maxCount = Math.max(maxCount, counts[k]);
        let maxSuit = 0; 
        for(let k in suits) maxSuit = Math.max(maxSuit, suits[k]);

        let isStraight = checkStraight(normalCards, jokers);
        let isFlush = (maxSuit + jokers) >= 5;
        let isRoyal = false;

        if (isFlush && isStraight) {
            let royalCards = normalCards.filter(c => c.val >= 10);
            if (royalCards.length + jokers >= 5) isRoyal = true;
        }

        let multiplier = 0;
        let highlightId = "";

        if (isRoyal) { multiplier = 100; highlightId = "row-royal"; }
        else if ((maxCount + jokers) >= 5) { multiplier = 50; highlightId = "row-five"; }
        else if (isFlush && isStraight) { multiplier = 20; highlightId = "row-strflush"; }
        else if ((maxCount + jokers) === 4) { multiplier = 10; highlightId = "row-four"; }
        else if (checkFullHouse(counts, jokers)) { multiplier = 5; highlightId = "row-full"; }
        else if (isFlush) { multiplier = 4; highlightId = "row-flush"; }
        else if (isStraight) { multiplier = 3; highlightId = "row-straight"; }
        else if ((maxCount + jokers) === 3) { multiplier = 1; highlightId = "row-three"; }
        else if (checkTwoPair(counts, jokers)) { multiplier = 1; highlightId = "row-twopair"; }
        else if (checkHighPair(counts, jokers)) { multiplier = 1; highlightId = "row-pair"; }

        if (highlightId) document.getElementById(highlightId).classList.add('highlight');
        return multiplier;
    }

    function checkHighPair(counts, jokers) {
        if (jokers > 0) return false;
        for (let val in counts) {
            if (counts[val] >= 2 && parseInt(val) >= 11) return true;
        }
        return false;
    }

    function checkStraight(cards, jokerCount) {
        if (cards.length === 0) return true;
        let vals = cards.map(c => c.val).sort((a,b) => a-b);
        vals = [...new Set(vals)]; 
        if (vals.length + jokerCount < 5) return false;
        let gap = vals[vals.length-1] - vals[0];
        if (gap <= 4) return true;
        return false; 
    }

    function checkFullHouse(counts, jokers) {
        let values = Object.values(counts);
        if (values.length === 2) return true;
        if (values.length === 1 && jokers >= 1) return true;
        return false;
    }

    function checkTwoPair(counts, jokers) {
        let pairs = 0;
        for(let k in counts) if (counts[k] >= 2) pairs++;
        if (pairs >= 2) return true;
        return false;
    }
</script>

</body>
</html>
